---
layout: post
title:  "[Sqlite]MJ write 시도"
date:   2016-08-02 20:50:00 +0000
categories: sqlite
tags: sqlite
---

- 후에 마스터저널을 사용하기 위해서, 저널 파일에 마스터저널의 이름(full path)을 저장하고 읽어야 한다.

- 기존 sqlite에서는 `writeMasterJournal()`과 `readMasterJournal()`을 사용한다. wal모드의 경우 현재 두 함수를 사용하지 않는다.(assert를 통해 체크된다)

- 기존 sqlite에서는 마스터저널의 이름을 저장할 때 저널 파일의 맨 뒤에 저장한다. 마스터저널의 생성은 commit단계에서 일어나고 commit이 끝날 때까지 저널에 데이터가 쓰이지 않기 때문에 문제가 없다.

- 하지만 WAL모드의 경우, commit중에도 저널 파일에 데이터가 쓰이기 때문에 이런 방법을 사용할 수 없다. 몇가지 방법 시도중

- 헤더를 늘리는 방법

  1. WAL의 헤더를 32바이트에서 36바이트로 늘리고 간단한 테스트 코드를 실행했다.

  2. 기존의 wal파일을 잘못된 db로 인식한다. 추후에 이 방법이 완전히 적용된다면 기존 wal 파일의 처리도 필요.

  3. 처음엔 문제가 생겼으나 실행을 반복하다보니 정상적으로 작동했다. 기존 저널파일을 깨끗하게 처리하지 못했던 것이 문제였던 듯 하다.

  4. 헤더 크기를 바꾸는 것이 위험하고, 써야 할 마스터저널 길이를 고정으로 할 수 없을 가능성이 높아 보류.

- 기존 저널과 반대로 저널파일 대신 DB파일 맨 끝에 마스터저널 정보를 쓰는 방법

  1. WAL이 기존 저널링과 반대의 방식으로 로그를 남긴다는 것에서 아이디어를 얻었다.

  2. 커밋중에 직접 데이터가 쓰이는 WAL파일 대신 .db파일에 마스터저널의 이름을 쓰고, 커밋이 끝날 때 지우는 방식

  3. .db파일에는 체크포인트가 실행될 때만 쓰이기 때문에 해볼만한 방법이라고 생각했으나, 체크포인트의 시점을 찾아본 결과 예측할 수 없다는 것을 깨닫고 드랍. 자세한 사항은 [CheckPoint](http://orc1226.github.io/2016/08/SQLite-CheckPoint) 참조
